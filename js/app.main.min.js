
/*
This file forms part of the NHS Choices Heart Age Tool.
It is copyright 2020 NHS Choices.
It is released under version 3 of the GNU General Public License
Source code, including a copy of the license is available at https://github.com/Antbits/heartage

It contains code derived from https://github.com/BritCardSoc/JBS3Risk released by University of Cambridge.
It also contains code derived from http://qrisk.org/lifetime/QRISK-lifetime-2011-opensource.v1.0.tgz released by ClinRisk Ltd.
*/
function analytics(p,d,o){var self=this
var unloaded=false
var data=d
var usr_str=Array('error','New user','Returning user')
var syn_id=p.syn_id
var vals
var makeID=function(l){var output="";var chars="123456789ABCDEFG";for(var i=0;i<l;i++)
output+=chars.charAt(Math.floor(Math.random()*chars.length));return output;}
var session_log={'origin':syn_id,'journey_id':makeID(16)}
var parent=p
this.getLog=function(){return session_log;}
this.antbitsLog=function(send,state){session_log.state=state;session_log=parent.getData(session_log)
session_log=parent.form.getData(session_log)
session_log=parent.results.getData(session_log)
session_log.origin=syn_id
session_log.id=data.id
session_log.d='desktop'
if(parent.isMobile.any()){session_log.d='phone'}
if(send){var output="//preview.antbits.com/tracking/tracker.gif?"
for(var key in session_log){output+=key+'='+session_log[key]+'&'}
output=output.slice(0,-1)
if(unloaded){navigator.sendBeacon("https://preview.antbits.com/tracking/tracker.gif",JSON.stringify(session_log));}else{$.ajax({type:'GET',url:output,dataType:'json',async:false});}}}
window.unload=function(){if(!unloaded){unloaded=true
session_log['unloaded']=true
self.antbitsLog(true,1)}}
window.onbeforeunload=function(){if(!unloaded){unloaded=true
session_log['unloaded']=true
self.antbitsLog(true,1)}}
$(window).blur(function(e){self.antbitsLog(false,0)})}
var formObj=function(parent){var self=this;var now=new Date()
self.parent=parent
self.unit_constraints={"inches":[0,11],"feet":[0,999],"cm":[0,999],"pounds":[0,13],"stone":[0,999],"kg":[0,999],"mmol":[0,20],"mgdl":[0,774],"mmhg":[0,210]}
self.form_data={}
var $feet_input=$('#heartage-height-feet')
var $inches_input=$('#heartage-height-inches')
var $cm_input=$('#heartage-height-cm')
var $kg_input=$('#heartage-weight-kg')
var $stone_input=$('#heartage-weight-stone')
var $pounds_input=$('#heartage-weight-pounds')
var $day_input=$('#heartage-dob-day')
var $month_input=$('#heartage-dob-month')
var $year_input=$('#heartage-dob-year')
var $total_cholesterol=$('#heartage-total_cholesterol-mmol')
var $hdl_cholesterol=$('#heartage-hdl_cholesterol-mmol')
var $postcode=$('#heartage-postcode')
var pc=0;var cholesterol_ratio=''
var postcode=''
var tn_queue=false;var locked=false;var conditions_warning={};this.setEvents=function(){$('#heartage-page-form input').on('click keyup',function(e){setTimeout(function(){self.checkErrorState(e)},50)})
$('#heartage-page-form #heartage-calculate-btn').on('click',function(e){e.preventDefault();if(!self.checkStatus($('#heartage-calculate-btn'),'locked')){if(self.validate($('#heartage-page-form .heartage-panel-light'))){}else{var pos=$('#heartage-page-form .heartage-panel-light.heartage-error').first().position();self.parent.scrollEvent(pos.top)
self.parent.resizeLayout(self.parent.size*3.75,self.parent.speed)
setTimeout(function(){$('#heartage-page-form .heartage-panel-light.heartage-error').first().find('input').first().focus()},self.parent.speed)}}})
$('#heartage-page-form input[type=radio][name=heartage-smoke]').change(function(){self.form_data.smoke_str=$($('#heartage-formpanel-smoke .nhsuk-radios>div>label')[this.value]).html()});$('#heartage-page-form input[type=radio][name=heartage-cvd]').change(function(){if(this.value=='true'){self.togglePanel($('#heartage-cvd-warning'),true)
self.lockFormItemsAfter('heartage-formpanel-cvd')}else{self.togglePanel($('#heartage-cvd-warning'),false)
self.unlockFormItems()}});$('#heartage-page-form input[type=radio][name=heartage-diabetes], #heartage-page-form input[type=radio][name=heartage-arthritis] , #heartage-page-form input[type=radio][name=heartage-ckd] , #heartage-page-form input[type=radio][name=heartage-atrfib]').change(function(e){var id=e.target.id.split('-')[1]
if(this.value=='true'){show_warning=true;for(var i in conditions_warning){if(conditions_warning[i]&&$('#heartage-'+i+'-warning').css('display')!='none'){show_warning=false;}}
if(show_warning){self.togglePanel($('#heartage-'+id+'-warning'),true)}
conditions_warning[id]=true;}else{self.togglePanel($('#heartage-'+id+'-warning'),false)
conditions_warning[id]=false;}});$('#heartage-page-form input[type=radio][name=heartage-cvdfam]').change(function(){if(this.value=='true'){self.togglePanel($('#heartage-cvdfam-warning'),true)}else{self.togglePanel($('#heartage-cvdfam-warning'),false)}});$('#heartage-page-form input[type=radio][name=heartage-cholesterol]').change(function(){if(this.value=='true'){self.togglePanel($('#heartage-cholesterol-input-panel'),true)}else{self.togglePanel($('#heartage-cholesterol-input-panel'),false)}});$('#heartage-page-form input[type=radio][name=heartage-bp]').change(function(){if(this.value=='true'){self.togglePanel($('#heartage-bp-input-panel'),true)}else{self.togglePanel($('#heartage-bp-input-panel'),false)}});$('#heartage-weight input, #heartage-height input , #heartage-cholesterol-input-panel input , #heartage-bp-input-panel input').on('keyup change',function(e){if(!locked){var tmp=e.target.id.split('-')
var val=Math.abs(e.target.value)
if(tmp[2]=='cm'||tmp[2]=='kg'||tmp[2]=='mmol'){val=val.toFixed(1)}else if(tmp[2]=='feet'||tmp[2]=='inches'||tmp[2]=='stone'||tmp[2]=='pounds'||tmp[2]=='mmhg'){val=Math.round(val)}
if(isNaN(val)){e.target.value=''}
if(val>0){var m=1
if(tmp[1].indexOf('cholesterol')){self.checkCholesterolRatio();}
if(tmp[1]=='hdl_cholesterol'){m=0.6}
var preval=val
val=Math.min(val,Math.floor(self.unit_constraints[tmp[2]][1]*m))
val=Math.max(val,Math.floor(self.unit_constraints[tmp[2]][0]*m))
if(val-preval!=0){e.target.value=val}}
self.convertUnits(tmp[1],tmp[2])}})
$('#heartage-dob-day').on('keyup',function(e){var val=$(this).val()
$(this).val(Math.min(val,31))})
$('#heartage-dob-month').on('keyup',function(e){var val=$(this).val()
$(this).val(Math.min(val,12))})
self.setUnitToggle('height','imperial','metric')
self.setUnitToggle('weight','imperial','metric')
self.setUnitToggle('cholesterol','mmol','mgdl')
self.parent.initDetails('heartage-page-form');self.initPanels('heartage-page-form');$('#heartage-cholesterol-advice').show();$('#heartage-bp-advice').show();$postcode.on('keyup',function(){self.tnQ();})
$postcode.on('blur',function(){self.tnQ();})
$(window).mousedown(function(e){self.parent.keynav=false;$('#tool_heart-age').removeClass('keynav');});$(window).keydown(function(e){if(e.keyCode==9||e.keyCode==13){self.parent.keynav=true;$('#tool_heart-age').addClass('keynav');}})}
this.clear=function(){self.form_data.townsend=null;$('#tool_heart-age input[type = text]').val('')
$('#tool_heart-age input[type = number]').val('')
$('#tool_heart-age input[type = radio]').prop('checked',false);self.togglePanel($('#heartage-cvd-warning'),false)
self.togglePanel($('#heartage-diabetes-warning'),false)
self.togglePanel($('#heartage-arthritis-warning'),false)
self.togglePanel($('#heartage-ckd-warning'),false)
self.togglePanel($('#heartage-atrfib-warning'),false)
self.togglePanel($('#heartage-cvdfam-warning'),false)
self.togglePanel($('#heartage-cholesterol-input-panel'),false)
self.togglePanel($('#heartage-bp-input-panel'),false)
$('#tool_heart-age details').removeAttr("style").removeAttr('open').removeClass('heartage-open').removeClass('heartage-dormant');}
this.testData=function(){$cm_input.val(177.8)
$kg_input.val(82.1)
$day_input.val(1)
$month_input.val(1)
$year_input.val(1970)
self.form_data.smoke_str='I smoke 20+ a day'
$postcode.val('GL14 3EX')
self.convertUnits('height','cm')
self.convertUnits('weight','kg')
self.checkTownsend()
$('input[type=radio]').attr('checked','checked')}
this.checkCholesterolRatio=function(){cholesterol_ratio=''
var tc=$total_cholesterol.val()
var hc=$hdl_cholesterol.val()
if(hc>tc&&hc!=''&&tc!=''){cholesterol_ratio='low'}else if(tc/hc>12.5&&hc!=''&&tc!=''){cholesterol_ratio='high'}}
this.checkErrorState=function(e){if(self.checkStatus($(e.target),'error')){self.validate($(e.target).closest('.heartage-panel-light'))}}
this.convertUnits=function(data_type,unit_type){locked=true
var val=0
if(unit_type=='feet'||unit_type=='inches'){val=($feet_input.val()*30.48)+($inches_input.val()*2.54)
if($feet_input.val()==''&&$inches_input.val()==''){$cm_input.val('')}else{$cm_input.val(val.toFixed(1))}}
if(unit_type=='cm'){val=$cm_input.val()
var feet=Math.floor(val/30.48);var inches=Math.round(val/2.54)-(feet*12);$feet_input.val(feet)
$inches_input.val(inches)}
if(unit_type=='stone'||unit_type=='pounds'){val=($stone_input.val()/0.157473)+($pounds_input.val()/2.204622)
if($stone_input.val()==''&&$pounds_input.val()==''){$kg_input.val('')}else{$kg_input.val(val.toFixed(1))}}
if(unit_type=='kg'){val=$kg_input.val()
var stone=Math.floor(val*0.157473);var pounds=Math.round(val*2.204622)-(stone*14);$stone_input.val(stone)
$pounds_input.val(pounds)}
if(unit_type=='mmol'){val=parseFloat($('#heartage-'+data_type+'-mmol').val());$('#heartage-'+data_type+'-mgdl').val((val*38.66976).toFixed(0));}
if(unit_type=='mgdl'){val=parseFloat($('#heartage-'+data_type+'-mgdl').val());$('#heartage-'+data_type+'-mmol').val((val*0.02586).toFixed(1));}
locked=false;}
this.initPanels=function(id){$("#"+id+" .heartage-warning").hide(0);$("#"+id+" .heartage-input-panel").hide(0);}
this.validate=function($target){var submit_form=false;if($target.length>1){submit_form=true;}
var valid=true;$target.each(function(index,element){var error='';var radio_checked=false
var text_inputted=false
var id=$(element).attr('id').replace('heartage-formpanel-','');$(element).find('input[type="text"], input[type="number"]').each(function(index,element){if($(element).val()==''){error=self.parent.data.TextAreas.error_incomplete_text}});if(error==''){text_inputted=true
self.form_data[id]=$(element).val();}
if($(element).find('input[type="radio"]').length>0){if($(element).find('input[type="radio"]:checked').length==0){error=self.parent.data.TextAreas.error_incomplete_radio}else{radio_checked=true
self.form_data[id]=$('input[name=heartage-'+id+']:checked').val()}}
switch(id){case'dob':if(error==''&&$year_input.val().length>=4){var oldest=new Date(now.getFullYear()-95,now.getMonth(),now.getDate());var youngest=new Date(now.getFullYear()-30,now.getMonth(),now.getDate());var dob=new Date($year_input.val(),$month_input.val()-1,$day_input.val());if(dob>youngest){error=self.parent.data.TextAreas.error_too_young}
if(dob<oldest){error=self.parent.data.TextAreas.error_too_old}
if(dob>now){error=self.parent.data.TextAreas.error_future_date}
if($year_input.val()!=dob.getFullYear()||$month_input.val()!=dob.getMonth()+1||$day_input.val()!=dob.getDate()){error=self.parent.data.TextAreas.error_incorrect_date}
self.form_data['dob']=dob}
if($year_input.val().length<4||$month_input.val().length<1||$day_input.val().length<1){error=self.parent.data.TextAreas.error_date_incomplete}
break;case'postcode':error='';break;case'sex':if(self.form_data['sex']==''){error=self.parent.data.TextAreas.error_sex}
break;case'eth':error='';break;case'height':error=''
if($cm_input.val()>50&&$cm_input.val()<241){self.form_data['height']=parseFloat($cm_input.val())}else if($cm_input.val()==''){error=self.parent.data.TextAreas.error_height_incomplete}else if($cm_input.val()<=50){error=self.parent.data.TextAreas.error_too_small.replace('[unit]','Height')}else if($cm_input.val()>=241){error=self.parent.data.TextAreas.error_too_large.replace('[unit]','Height')}else{error=self.parent.data.TextAreas.error_height_incomplete}
break;case'weight':error=''
if($kg_input.val()>12&&$kg_input.val()<318){self.form_data['weight']=parseFloat($kg_input.val())}else if($kg_input.val()==''){error=self.parent.data.TextAreas.error_weight_incomplete}else if($kg_input.val()<=12){error=self.parent.data.TextAreas.error_too_small.replace('[unit]','Weight')}else if($kg_input.val()>=318){error=self.parent.data.TextAreas.error_too_large.replace('[unit]','Weight')}else{error=self.parent.data.TextAreas.error_weight_incomplete}
break;case'cholesterol':if(radio_checked){if($("input[name='heartage-cholesterol']:checked").val()=='true'){self.checkCholesterolRatio()
if(text_inputted&&cholesterol_ratio==''){error=''}else if(cholesterol_ratio!=''){error=self.parent.data.TextAreas['error_cholesterol_ratio_'+cholesterol_ratio]}else{error=self.parent.data.TextAreas.error_incomplete_text}
self.form_data['ch_skipped']=false;self.form_data['cholesterol']={'total':$('#heartage-total_cholesterol-mmol').val(),'hdl':$('#heartage-hdl_cholesterol-mmol').val()}}else{error=''
self.form_data['ch_skipped']=true;self.form_data['cholesterol']={'total':0,'hdl':0}}}
break;case'bp':self.form_data['bp']=self.parent.results.baseline.sbp
if(radio_checked){if($("input[name='heartage-bp']:checked").val()=='true'){if(text_inputted){self.form_data['bp']=$('#heartage-bp-mmhg').val()
error=''}else{error=self.parent.data.TextAreas.error_incomplete_text}
self.form_data['bp_skipped']=false;}else{error=''
self.form_data['bp_skipped']=true;}}
break;default:break;}
var $old_errors=$(element).find('.heartage-error-msg')
if($old_errors.length>0&&error==''){$(element).removeClass('heartage-error')
$old_errors.stop().slideUp(self.parent.speed,function(){$(this).remove();})}
if(error!=''){if($old_errors.length>0){$(element).find('.heartage-error-msg').html(error)}else{$(element).find('h3').after('<div class = "heartage-error-msg">'+error+'</div>')}
$(element).addClass('heartage-error');valid=false;}});if(valid&&submit_form){var age=Math.floor((now.getTime()-self.form_data['dob'].getTime())/31557600000);var bmi=self.form_data.weight/Math.pow(self.form_data.height/100,2);if(self.form_data.ch_skipped){var rati=self.parent.results.baseline.rati}else{var rati=parseFloat(self.form_data.cholesterol.total)/parseFloat(self.form_data.cholesterol.hdl)}
if(self.form_data.bp_skipped){var sbp=self.parent.results.baseline.sbp}else{var sbp=parseInt(self.form_data.bp)}
self.form_data.heartage_input={"age":age,"b_AF":eval(self.form_data.atrfib),"b_ra":eval(self.form_data.arthritis),"b_renal":eval(self.form_data.ckd),"b_treatedhyp":eval(self.form_data.bpt),"b_type2":eval(self.form_data.diabetes),"bmi":bmi,"surv":95-age,"tc":0,"bmi_rounded":parseFloat(bmi.toFixed(1)),"fh_cvd":eval(self.form_data.cvdfam),"gender":parseInt(self.form_data.sex),"rati":rati,"sbp":sbp,"smoke_cat":parseInt(self.form_data.smoke)}
if(!isNaN(self.form_data.eth)&&self.form_data.eth!=''){self.form_data.heartage_input.ethrisk=parseInt(self.form_data.eth);}else{self.form_data.heartage_input.ethrisk=0;}
if(!isNaN(self.form_data.cholesterol.total)&&self.form_data.cholesterol.total!=''){self.form_data.heartage_input.tc=self.form_data.cholesterol.total}else{self.form_data.heartage_input.tc=0;}
if(self.form_data.townsend==null){self.form_data.heartage_input.town=self.parent.results.baseline.town}else{if(typeof self.form_data.townsend.townsend_score=='undefined'||self.form_data.townsend.townsend_score==null){self.form_data.heartage_input.town=self.parent.results.baseline.town}else{self.form_data.heartage_input.town=parseFloat(self.form_data.townsend.townsend_score)}}
self.parent.results.preload(self.form_data)}
return valid}
this.tnQ=function(){if(!tn_queue){tn_queue=true;setTimeout(function(){self.checkTownsend();tn_queue=false;},2000);}}
this.checkTownsend=function(){var regPostcode=/([Gg][Ii][Rr] 0[Aa]{2})|((([A-Za-z][0-9]{1,2})|(([A-Za-z][A-Ha-hJ-Yj-y][0-9]{1,2})|(([A-Za-z][0-9][A-Za-z])|([A-Za-z][A-Ha-hJ-Yj-y][0-9]?[A-Za-z]))))\s?[0-9][A-Za-z]{2})/gi;if(postcode!=$postcode.val().replace(' ','')){$postcode.val(addSpace($postcode.val()).toUpperCase());postcode=$postcode.val().replace(' ','');if(regPostcode.test(postcode)){pc=1;$.getJSON(self.parent.townsend_api_path+'?p='+postcode,function(data){if(data.success){self.form_data['townsend']=data;}else{self.form_data['townsend']=null;}});}else{postcode='';self.form_data['townsend']=null}}
function addSpace(str){str=str.replace(' ','');switch(str.length){case 7:return str.slice(0,4)+' '+str.slice(4,7)
break
case 6:return str.slice(0,3)+' '+str.slice(3,6)
break
default:return str;break;}}}
this.togglePanel=function($target,openstate){if(openstate){$target.addClass('heartage-activated')
$target.css('display','block')
$target.addClass('heartage-dormant')
setTimeout(function(){var h=$target.outerHeight(true)-self.parent.size
self.parent.resizeLayout(h+(3.75*self.parent.size),self.parent.speed);$target.addClass('heartage-zero-height');$target.css('margin-top',0)
$target.removeClass('heartage-dormant').stop().animate({'height':h,'padding-top':'1em','padding-bottom':'1em','margin-top':'1em'},self.parent.speed,function(){$(this).removeClass('heartage-zero-height')
$(this).attr('style','')
$(this).css('height','auto')})},50)}else{if($target.hasClass('heartage-activated')){self.parent.resizeLayout(0-$target.height(),self.parent.speed);$target.stop().animate({'height':0,'padding-top':0,'padding-bottom':0,'margin-top':0},self.parent.speed,function(){$target.removeAttr("style");$target.hide();})}}}
this.lockFormItemsAfter=function(target){var locked=false;$('#heartage-page-form .heartage-panel-light').each(function(index,element){if(locked){$(element).addClass('heartage-locked')
$(element).stop().fadeTo(self.parent.speed,0.3)
$(element).find('input').attr('disabled','true')
$(element).find('nhsuk-radios__input').attr('disabled','true')}
if($(element).attr('id')==target){locked=true;}});$('#heartage-calculate-btn').addClass('heartage-locked').stop().fadeTo(self.parent.speed,0.3)}
this.unlockFormItems=function(){$('#heartage-page-form .heartage-panel-light').each(function(index,element){$(element).removeClass('heartage-locked')
$(element).stop().fadeTo(self.parent.speed,1)
$(element).find('input').attr('disabled',null)
$(element).find('nhsuk-radios__input').attr('disabled',null)});$('#heartage-calculate-btn').stop().removeClass('heartage-locked').fadeTo(self.parent.speed,1)}
this.checkStatus=function($target,state){if($target.parents('.heartage-'+state).length||$target.hasClass('heartage-'+state)){return true;}else{return false;}}
this.setUnitToggle=function(id,first,last){$('#heartage-formpanel-'+id+' .heartage-'+last).stop().fadeOut(0)
$('#heartage-formpanel-'+id+' .heartage-unit-toggle a:last-of-type').stop().fadeOut(0).click({target:id,units:first,first:first,last:last},function(event){self.toggleUnits(event.data.units,event.data.target,event.data.first,event.data.last)})
$('#heartage-formpanel-'+id+' .heartage-unit-toggle a:first-of-type').click({target:id,units:last,first:first,last:last},function(event){self.toggleUnits(event.data.units,event.data.target,event.data.first,event.data.last)})}
this.toggleUnits=function(unit_type,target,first,last){if(!locked){locked=true
var next=first
var $wrap=$('#heartage-'+target)
if(!self.checkStatus($('#heartage-formpanel-'+target),'locked')){$wrap.height($wrap.height())
if(unit_type==first){$('#heartage-formpanel-'+target+' .heartage-unit-toggle a:last-of-type').stop().fadeOut(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-unit-toggle a:first-of-type').stop().delay(self.parent.speed).fadeIn(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-'+last).stop().fadeOut(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-'+first).stop().delay(self.parent.speed).fadeIn(self.parent.speed,function(){locked=false
$wrap.css('height',null)})}else{$('#heartage-formpanel-'+target+' .heartage-unit-toggle a:first-of-type').stop().fadeOut(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-unit-toggle a:last-of-type').stop().delay(self.parent.speed).fadeIn(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-'+first).stop().fadeOut(self.parent.speed)
$('#heartage-formpanel-'+target+' .heartage-'+last).stop().delay(self.parent.speed).fadeIn(self.parent.speed,function(){locked=false
$wrap.css('height',null)})
next=last}}
if(self.parent.keynav){setTimeout(function(){$($('#heartage-formpanel-'+target+' .heartage-'+next+' input')[0]).focus()},self.parent.speed);}}}
this.getData=function(obj){if(!isNaN(self.form_data.height)){obj.hcm=self.form_data.height;}
if(!isNaN(self.form_data.weight)){obj.wkg=self.form_data.weight;}
if(!self.form_data.bp_skipped){obj.sbp=parseInt(self.form_data.bp)}else{obj.sbp=0;}
if(!isNaN(self.form_data.smoke)){obj.smk=self.form_data.smoke;}
if(self.form_data.cholesterol!=null){if(!isNaN(self.form_data.cholesterol.hdl)){obj.chs=parseFloat(self.form_data.cholesterol.hdl);}
if(!isNaN(self.form_data.cholesterol.total)){obj.cht=parseFloat(self.form_data.cholesterol.total);}
if(obj.cht>0&&obj.chs>0&&!self.form_data.ch_skipped){obj.ch=obj.cht/obj.chs}else{obj.ch=0;}}
if(self.form_data.townsend!=null){obj.lsoa11=self.form_data.townsend.lsoa11;obj.upper_tier_LA=self.form_data.townsend.upper_tier_LA;obj.region=self.form_data.townsend.region;obj.r=self.form_data.townsend.region;obj.area_name=self.form_data.townsend.area_name;obj.tn=self.form_data.townsend.townsend_score}
obj.pc=pc;if(!isNaN(self.form_data.ethrisk)){obj.et=$('input[name=heartage-eth]:checked').siblings('label').html()
obj.eth=parseInt(self.form_data.eth);}else{obj.et='Not known'
obj.eth=0;}
return obj}
function countDecimals(value){if(Math.floor(value)!==value)
return value.toString().split(".")[1].length||0;return 0;}}
function heartageObj(src){var self=this;this.lifetimeObj=null
var statusObj={'status_str':'Loading lookup data','status':0,'result':null,'user_data':null};this.data=null;this.init=function(src){self.loadJSON(function(response){self.lookup_data=JSON.parse(response);statusObj.status_str='Lookup data loaded';statusObj.status=1;self.lifetimeObj=new Q65_lifetime(self.lookup_data);},src);}
this.getStatus=function(){return statusObj;}
this.getHeartage=function(data){if(statusObj.status<1){return statusObj;}else{statusObj.result=null;statusObj.user_data=data;statusObj.result=self.lifetimeObj.lifetimeRisk(data)
statusObj.status_str='Result set successfully generated';statusObj.status=2;return statusObj;}}
this.loadJSON=function(callback,src){var xobj=new XMLHttpRequest();xobj.open('GET',src,true);xobj.onreadystatechange=function(){if(xobj.readyState==4&&xobj.status=="200"){callback(xobj.responseText);}else{statusObj.status_str='Lookup data not found please check src parameter';}}
xobj.send(null);;}
function Q65_female_cvd(data_obj){for(var i in data_obj){eval('var '+i+' = '+data_obj[i]);}
var a;var Iethrisk=new Array(0,0,0.3519781359171325100000000,0.7125701233074622800000000,0.4744736904914790800000000,0.1277734031153024400000000,0.0276815264451465880000000,-0.3676643548251001300000000,-0.2636321488403285400000000,-0.0064333267101571784000000);var Ismoke=new Array(0,0.1609363217948046300000000,0.3282477751045009300000000,0.4541679502935254700000000,0.6076275665698729300000000);a=0;a+=Iethrisk[ethrisk];a+=Ismoke[smoke_cat];a+=(Math.sqrt(bmi/10)-1.605074524879456)*0.2813726290228962300000000;a+=(rati-3.705839872360230)*0.1551217926855477100000000;a+=(sbp-129.823593139648440)*0.0062458135965802464000000;a+=(town+0.301369071006775)*0.0239763590547845720000000;a+=b_AF*0.6363540037072725800000000;a+=b_ra*0.3607328778130438100000000;a+=b_renal*0.5144859684018359100000000;a+=b_treatedhyp*0.2825312388249602800000000;a+=b_type2*0.5114309272510256800000000;a+=fh_cvd*0.5135507323965317100000000;return a;}
function Q65_male_cvd(data_obj){for(var i in data_obj){eval('var '+i+' = '+data_obj[i]);}
var a;var bmi_1;var Iethrisk=new Array(0,0,0.4035656542786645300000000,0.7159343574607238700000000,0.7588068966921870400000000,0.2778257996405138500000000,-0.3383277413537653700000000,-0.3626891973109574500000000,-0.2406220118164148500000000,-0.1055741084408314400000000);var Ismoke=new Array(0,0.1655389770495527800000000,0.3227167436634277900000000,0.4393091679622852500000000,0.5830168090609184600000000);a=0;a+=Iethrisk[ethrisk];a+=Ismoke[smoke_cat];a+=(Math.log(bmi/10)-0.967572152614594)*0.4325953310683352500000000;a+=(rati-4.439734935760498)*0.1616093175199347100000000;a+=(sbp-133.265686035156250)*0.0051706475575211365000000;a+=(town+0.164980158209801)*0.0118372789415412600000000;a+=b_AF*0.4871573476846625100000000;a+=b_ra*0.3165460738113234400000000;a+=b_renal*0.4665323499934942400000000;a+=b_treatedhyp*0.3146452536778831000000000;a+=b_type2*0.4700445024972483300000000;a+=fh_cvd*0.6101222792348441900000000;return a;}
function Q65_female_death(data_obj){for(var i in data_obj){eval('var '+i+' = '+data_obj[i]);}
var a;var bmi_1;var Iethrisk=new Array(0,0,-0.7691412217114335100000000,-0.4813884489809012200000000,-0.6649693187337454300000000,-0.9806514018090445300000000,-0.7665687475367323200000000,-0.3079908452168220200000000,-1.1084520766868413000000000,-0.9729355194482460800000000);var Ismoke=new Array(0,0.2343310901409800500000000,0.5870690502658261200000000,0.7964460203072020200000000,1.0533145224303277000000000);var dbmi=bmi;dbmi=dbmi/10;bmi_1=Math.pow(dbmi,.5);a=0;a+=Iethrisk[ethrisk];a+=Ismoke[smoke_cat];a+=(Math.sqrt(bmi/10)-1.605074524879456)*-0.1081416642130314200000000;a+=(rati-3.705839872360230)*0.0273178320909109660000000;a+=(sbp-129.823593139648440)*-0.0008337937584279265700000;a+=(town+0.301369071006775)*0.0366304184773099120000000;a+=b_AF*0.5484061247122409300000000;a+=b_ra*0.4667078978482423500000000;a+=b_renal*1.0288138959180866000000000;a+=b_treatedhyp*-0.0500562994738190240000000;a+=b_type2*0.6543819525425483800000000;a+=fh_cvd*-0.4629154246984292800000000;return a;}
function Q65_male_death(data_obj){for(var i in data_obj){eval('var '+i+' = '+data_obj[i]);}
var a;var Iethrisk=new Array(0,0,-0.7959493840935216700000000,-0.8983542916653508600000000,-0.8464836394282484500000000,-1.3907364202494530000000000,-0.7939585494106227200000000,-0.6696772151327180500000000,-1.3074649266863319000000000,-1.0983395480170892000000000);var Ismoke=new Array(0,0.2306667408386281800000000,0.5716670855343914900000000,0.7849316319893276900000000,1.0119244230108204000000000);a=0;a+=Iethrisk[ethrisk];a+=Ismoke[smoke_cat];a+=(Math.log(bmi/10)-0.967572152614594)*-0.4077463700204617700000000;a+=(rati-4.439734935760498)*-0.0137508433127115260000000;a+=(sbp-133.265686035156250)*0.0005828619709622257200000;a+=(town+0.164980158209801)*0.0509394028862269410000000;a+=b_AF*0.4141766179931511400000000;a+=b_ra*0.4757132805164633300000000;a+=b_renal*0.8498597130356305700000000;a+=b_treatedhyp*0.0722059208073983630000000;a+=b_type2*0.4918060293979553700000000;a+=fh_cvd*-0.3664212379436541700000000;return a;};function Q65_lifetime(lookup_data){var self=this;var a_cvd_obj_0,a_cvd_obj_1,a_death_obj_0,a_death_obj_1;var compare_period=10;var centerings=[{bmi:10*1.605074524879456*1.605074524879456,rati:3.5,sbp:120,town:-0.301369071006775},{bmi:10*Math.exp(0.967572152614594),rati:3.5,sbp:120,town:-0.164980158209801}];this.lookup=lookup_data;this.find_biggest_t_below_number_in_array=function(number,array,arrayNumberOfRows){var i;var found=0;if(array._t[0]>=number){return-2;}
for(i=0;i<arrayNumberOfRows;i++){if(array._t[i]>=number){found=1;break;}}
if(found){i--;}else{i=-1;}
return(i);}
this.produceLifetimeRiskTable=function(timeTable,from,to,a_cvd,a_death,sex,followupYear){var resultArray=new Array();var annualRiskTable=new Array();var annualRiskTable_int=new Array();var sage=30;var lage=95;var timeTableIndex=from;;var exp_a_cvd=Math.exp(a_cvd);var exp_a_death=Math.exp(a_death);var t0=Math.round(timeTable[timeTableIndex][0]);var lastRow;var newRow;var lastRow_int;var newRow_int;var nYearRisk=0;var t=t0-1;var sum_e_int=0;for(var i=0;i<=(timeTable.length-from-2);i++){var baseHazard={"death":timeTable[timeTableIndex][1]*exp_a_death,"cvd":timeTable[timeTableIndex][2]*exp_a_cvd}
var baseHazard_int={"death":timeTable[timeTableIndex][1]*exp_a_death,"cvd":timeTable[timeTableIndex][2]*exp_a_cvd}
if(i==0){lastRow=new LifetimeRiskRow(1-baseHazard.cvd-baseHazard.death,baseHazard.cvd,baseHazard.death,1-baseHazard.cvd,baseHazard.cvd);lastRow_int=new LifetimeRiskRow(1-baseHazard_int.cvd-baseHazard_int.death,baseHazard_int.cvd,baseHazard_int.death,1-baseHazard_int.cvd,baseHazard_int.cvd);}else{newRow=new LifetimeRiskRow(lastRow.S_1*(1-baseHazard.cvd-baseHazard.death),lastRow.cif_cvd+lastRow.S_1*baseHazard.cvd,lastRow.cif_death+lastRow.S_1*baseHazard.death,lastRow.S_noDeath*(1-baseHazard.cvd),lastRow.cvd_noDeath+lastRow.S_noDeath*baseHazard.cvd);newRow_int=new LifetimeRiskRow(lastRow_int.S_1*(1-baseHazard_int.cvd-baseHazard_int.death),lastRow_int.cif_cvd+lastRow_int.S_1*baseHazard_int.cvd,lastRow_int.cif_death+lastRow_int.S_1*baseHazard_int.death,lastRow_int.S_noDeath*(1-baseHazard_int.cvd),lastRow_int.cvd_noDeath+lastRow_int.S_noDeath*baseHazard_int.cvd);lastRow=newRow;lastRow_int=newRow_int;}
t1=Math.floor(timeTable[timeTableIndex][0]);if(t1>t){t=t1;annualRiskTable.push(lastRow);annualRiskTable_int.push(lastRow_int);};if(t>=followupYear-1){;nYearRisk=lastRow.cif_cvd;}
timeTableIndex++;}
annualRiskTable.push(lastRow);annualRiskTable_int.push(lastRow_int);for(i=0;i<annualRiskTable.length;i++){sum_e_int+=100*annualRiskTable[i].S_1;}
return{"life":(sum_e_int/100),"annualRiskTable_int":annualRiskTable_int,"annualRiskTable":annualRiskTable,"nYearRisk":nYearRisk,"hazard":self.getNoDeathHazardAt(annualRiskTable,0)}}
this.produceLifetimeRiskTable_int=function(timeTable,from,to,a_cvd,a_death,sex,followupYear){var timeTableIndex=from;var timeTableIndex_int=from;var t0=parseInt(timeTable[timeTableIndex][0]);var t0_int=parseInt(timeTable[timeTableIndex][0]);var annualRiskTable=new Array();var annualRiskTable_int=new Array();var lastRow,lastRow_int,newRow,newRow_int;var nYearRisk=0;var exp_a_cvd=Math.exp(a_cvd);var exp_a_death=Math.exp(a_death);var t=t0-1;var f=from;for(i=f-from;i<(timeTable.length-from-2);f++,i++){;var baseHazard={"death":timeTable[timeTableIndex][1]*exp_a_death,"cvd":timeTable[timeTableIndex][2]*exp_a_cvd}
var baseHazard_int={"death":timeTable[timeTableIndex][1]*exp_a_death,"cvd":timeTable[timeTableIndex][2]*exp_a_cvd}
if(i==0){lastRow=new LifetimeRiskRow(1-baseHazard.cvd-baseHazard.death,baseHazard.cvd,baseHazard.death,1-baseHazard.cvd,baseHazard.cvd);lastRow_int=new LifetimeRiskRow(1-baseHazard_int.cvd-baseHazard_int.death,baseHazard_int.cvd,baseHazard_int.death,1-baseHazard_int.cvd,baseHazard_int.cvd);}else{newRow=new LifetimeRiskRow(lastRow.S_1*(1-baseHazard.cvd-baseHazard.death),lastRow.cif_cvd+lastRow.S_1*baseHazard.cvd,lastRow.cif_death+lastRow.S_1*baseHazard.death,lastRow.S_noDeath*(1-baseHazard.cvd),lastRow.cvd_noDeath+lastRow.S_noDeath*baseHazard.cvd);newRow_int=new LifetimeRiskRow(lastRow_int.S_1*(1-baseHazard_int.cvd-baseHazard_int.death),lastRow_int.cif_cvd+lastRow_int.S_1*baseHazard_int.cvd,lastRow_int.cif_death+lastRow_int.S_1*baseHazard_int.death,lastRow_int.S_noDeath*(1-baseHazard_int.cvd),lastRow_int.cvd_noDeath+lastRow_int.S_noDeath*baseHazard_int.cvd);lastRow=newRow;lastRow_int=newRow_int;}
t1=Math.floor(timeTable[timeTableIndex][0]);if(t1>t){t=t1;annualRiskTable.push(lastRow);annualRiskTable_int.push(lastRow_int);}
if(t>=followupYear-1){nYearRisk=lastRow.cif_cvd;}
timeTableIndex++;}
annualRiskTable.push(lastRow);annualRiskTable_int.push(lastRow_int);;return{"annualRiskTable_int":annualRiskTable_int,"annualRiskTable":annualRiskTable,"nYearRisk":nYearRisk,"hazard":self.getNoDeathHazardAt(annualRiskTable,0)}}
this.getNoDeathHazardAt=function(rows,index){index=Math.min(index,rows.length-2);if(index<0){return 0;}else{return(rows[index+1].cvd_noDeath-rows[index].cvd_noDeath)/rows[index].S_noDeath;}}
this.lifetimeRisk=function(user_data){var cage=user_data.age;var sex=user_data.gender;var noOfFollowupYears=compare_period;var startRow,baseArray,finishRow,resultArraySize,lifetimeRisk,followupIndex,nYearRisk,followupRow,a_cvd,a_death,timeTable,arrayNumberOfRows,resultArray,last,base_data,life;if(sex==0){a_cvd=Q65_female_cvd(user_data);a_death=Q65_female_death(user_data);timeTableRaw=self.lookup.female;arrayNumberOfRows=self.lookup.female._t.length;}else{a_cvd=Q65_male_cvd(user_data);a_death=Q65_male_death(user_data);timeTableRaw=self.lookup.male;arrayNumberOfRows=self.lookup.male._t.length;};var possibly_younger=false;var sage=30;var lage=95;var heartage=cage-1;var baseResult,baseResult_int,userResult,userResult_int;var timeTable=new Array();for(var i=0;i<=timeTableRaw._t.length;i++){timeTable.push([timeTableRaw._t[i],timeTableRaw.basehaz_death_0_30[i],timeTableRaw.basehaz_cvd_0_30[i]]);};startRow=Math.max(0,self.find_biggest_t_below_number_in_array(cage-sage,timeTableRaw,arrayNumberOfRows)+1);finishRow=arrayNumberOfRows-1;resultArraySize=finishRow-startRow;userResult=self.produceLifetimeRiskTable(timeTable,startRow,finishRow,a_cvd,a_death,sex,lage-sage);life=(cage+userResult.life);userResult_int=self.produceLifetimeRiskTable_int(timeTable,startRow,finishRow,a_cvd,a_death,sex,lage-sage);followupIndex=cage-sage+noOfFollowupYears;base_data={};base_data.town=centerings[sex].town;base_data.bmi=centerings[sex].bmi;base_data.sbp=centerings[sex].sbp;base_data.rati=centerings[sex].rati;base_data.ethrisk=user_data.ethrisk;base_data.b_type1=false;base_data.b_type2=false;base_data.b_AF=false;base_data.b_ra=false;base_data.b_renal=false;base_data.b_treatedhyp=false;base_data.fh_cvd=false;base_data.smoke_cat=0;base_data.surv=noOfFollowupYears;if(sex==0){a_cvd=Q65_female_cvd(base_data);a_death=Q65_female_death(base_data);}else{a_cvd=Q65_male_cvd(base_data);a_death=Q65_male_death(base_data);};baseResult=self.produceLifetimeRiskTable(timeTable,startRow,finishRow,a_cvd,a_death,sex,lage-sage);for(var i in baseResult.annualRiskTable_int){if(self.getNoDeathHazardAt(baseResult.annualRiskTable_int,i)>userResult.hazard){if(i==0){possibly_younger=true;}
break;}};if(possibly_younger){var d_gp=self.getNoDeathHazardAt(baseResult.annualRiskTable_int,1)-self.getNoDeathHazardAt(baseResult.annualRiskTable_int,0);var gpHazard=self.getNoDeathHazardAt(baseResult.annualRiskTable_int,0);while((i>-5)&&(gpHazard-=d_gp)>userResult.hazard){i--;}}else{var myHazard=userResult_int.hazard;var h_i=self.getNoDeathHazardAt(baseResult.annualRiskTable_int,i);var h_i_1=self.getNoDeathHazardAt(baseResult.annualRiskTable_int,i-1);if(h_i!=h_i_1){i-=(h_i-myHazard)/(h_i-h_i_1);}}
heartage=Math.min(95,Math.round(parseFloat(cage)+parseFloat(i)));var compare_index=Math.min(compare_period,userResult.annualRiskTable_int.length-1);return{'life':life,'heartage':heartage,'risk':userResult.hazard,'10_yr_risk':Math.round((userResult.annualRiskTable_int[compare_index].cvd_noDeath)*1000)/10,'nYearRisk':userResult.nYearRisk}}
function LifetimeRiskRow(S_1,cif_cvd,cif_death,S_noDeath,cvd_noDeath){this.S_1=S_1
this.cif_cvd=cif_cvd
this.cif_death=cif_death
this.S_noDeath=S_noDeath
this.cvd_noDeath=cvd_noDeath}}
this.init(src);}
var heartageIndex=function(path,$target,config,nocache){var self=this;self.page=0
self.$target=$target;self.config=config;self.loaded=0;self.speed=300;self.size=16
self.postmessage=false
self.syn_id='nhs'
self.msg_obj={"id":"heartage","data":{},"action":"init"}
self.width=$(window).width();self.keynav=false;self.framed=false;self.path=path;self.page_names=['splash','form','results'];self.page_divs=[];self.urlvars=getUrlVars();self.townsend_api_path='//preview.antbits.com/townsend/api.php';self.edge=window.navigator.userAgent.indexOf("Edge")>-1
var locked,h,s,poller
var page_title=$('title').html()
self.config.tool_name='One You Heart Age'
self.config.tool_category='Self assessments'
self.config.tool_id='OneYouHA'
self.config.tool_title='How healthy is your heart'
self.config.accessibility_titles={"form":"Please fill in your details","results":"Your heart age result"}
self.config.adobe_state=0
if(document.referrer.indexOf('developer.api.nhs.uk')>-1){self.config.adobe_analytics=false;}
if(self.urlvars.hasOwnProperty('syn_id')){self.syn_id=self.urlvars.syn_id;self.env='syndicated'
self.syndicate=true;}else{self.syn_id='nhs';self.syndicate=false;}
if(self.config.adobe_analytics&&self.config.framed){$('head').append('<script src="'+self.path+'js/datalayer.js"></script>')
$('head').append('<script src="//assets.adobedtm.com/launch-ENe7f6cdd7cc05409b86547d9153429788.min.js" async></script>')
$('head').append("<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-NQPC6C');</script>");}
$.getJSON(path+'data.json?nocache='+nocache,function(data){self.data=data;self.data.TextAreas['path']=path
if(self.urlvars.framed){self.framed=true
$target.addClass('heartage-framed')
window.addEventListener("message",NHStoolMessage,false);function NHStoolMessage(e){var data=(JSON.parse(event.data));if(typeof(data.action)!='undefined'&&data.id=='heartage'){switch(data.action){case"init":self.postmessage=true
self.init();break;}}}
window.parent.postMessage(JSON.stringify(self.msg_obj),'*');var element=document.getElementById('tool_heart-age');$(window).on('resize',function(){if($(this).width()!==self.width){self.width=$(this).width();self.resizeLayout((3.75*self.size),0);}});}else{self.init();}})
$('head').append('<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">')
this.resizeLayout=function(adjust,speed){if(self.postmessage){self.msg_obj.action="resize"
self.msg_obj.data={"height":($target.height()+adjust),"speed":self.speed};window.parent.postMessage(JSON.stringify(self.msg_obj),'*');}}
this.scrollEvent=function(y){if(self.postmessage){self.msg_obj.action="scroll"
self.msg_obj.data={"y":y,"speed":self.speed};window.parent.postMessage(JSON.stringify(self.msg_obj),'*');}else{var distance=$("html, body").scrollTop()-y;$("html, body").animate({scrollTop:y},self.speedAdjust(distance,self.speed));}}
this.speedAdjust=function(distance,speed){var s=speed*(1,Math.sqrt(distance)*0.05)
s=Math.min(1000,Math.max(300,s))
return s}
this.init=function(){$target.html('')
for(var i in self.page_names){$page=$('<div id  = "heartage-page-'+self.page_names[i]+'" class="heartage-page"></div>')
$target.append($page)
$page.load(path+'/templates/heartage-'+self.page_names[i]+'.html?nocache='+nocache,function(){self.processTemplate($(this));})
if(i>0){$page.stop().fadeOut(0);}
self.page_divs.push($page);}}
this.nav=function(destination){var h1=$('#tool_heart-age').outerHeight(true);var h2=$('#heartage-page-'+destination).outerHeight(true)
self.resizeLayout(h2-h1,self.speed);$('#tool_heart-age').height(h1)
$('title').html(page_title+' | '+self.config.accessibility_titles[destination])
for(var i in self.page_divs){self.page_divs[i].addClass('heartage-fixed')
if(destination==self.page_names[i]){self.page_divs[i].stop().delay(self.speed).fadeIn(self.speed,function(){self.resizeLayout(self.size*2,0);})
$('#tool_heart-age').height(h1).stop().animate({'height':h2},(self.speed*2),function(){$('#tool_heart-age>div').removeClass('heartage-fixed')
$('#tool_heart-age').css('height','auto')})
self.scrollEvent($('#tool_heart-age').position().top)
if(self.keynav){if(destination=='results'){$('#heartage-masthead>span').focus()}else{$('#heartage-page-'+destination+' h2:first-of-type').focus()}}}else{self.page_divs[i].stop().fadeOut(self.speed)}}}
this.initDetails=function(id){var pad=3.75
h=0;var findDiv=function(e){if(e.target.nodeName=='SPAN'){return $($(e.target.parentNode.parentNode).find('div')[0])}else{return $($(e.target.parentNode).find('div')[0])}}
var findDetails=function(e){if(e.target.nodeName=='SPAN'){return $(e.target.parentNode.parentNode)}else{return $(e.target.parentNode)}}
if(self.edge){var $nodes=$("#"+id+" .heartage-edge-summary")
locked=true;$("#"+id+" .heartage-edge-details>div").hide()
$nodes.click(function(e){if($(e.target).parents('.heartage-locked').length==0){var $div=findDiv(e)
var $details=findDetails(e)
if($details.hasClass('heartage-open')){self.resizeLayout(0-$div.height(),self.speed);$div.stop().animate({height:0,marginTop:0},self.speed,function(){$details.removeClass('heartage-open')
$div.removeAttr("style");$(this).hide();});}else{var h=$div.outerHeight(true)
self.resizeLayout(h+(3.75*self.size),self.speed);$div.show().addClass('heartage-zero-height')
$div.stop().animate({height:h,marginTop:'1em'},self.speed,function(){locked=false;$(this).removeClass('heartage-zero-height')
$details.addClass('heartage-open')
$(this).css('height','auto')});}}else{e.preventDefault();}})}else{var $nodes=$("#"+id+" details>summary")
$nodes.click(function(e){if($(e.target).parents('.heartage-locked').length==0&&!locked&&!self.form.checkStatus($(e.target),'locked')){if(!self.keynav){var $div=findDiv(e)
var $details=findDetails(e)
locked=true;if($details.attr('open')=='open'||$details.hasClass('heartage-open')){e.preventDefault();self.resizeLayout(0-$div.height(),self.speed)
$div.animate({'height':0,'margin-top':0},self.speed,function(){locked=false;$details.removeAttr('open').removeClass('heartage-open')
$(this).removeClass('heartage-zero-height');$(this).removeClass('heartage-dormant');$div.removeAttr("style")})}else{$div.addClass('heartage-dormant');locked=true;poller=setInterval(function(){if($div.height()>0){h=$div.height()
self.resizeLayout(h+(pad*self.size),self.speed)
$div.addClass('heartage-zero-height');$div.removeClass('heartage-dormant');$div.animate({'height':h+'px','margin-top':'1em'},self.speed,function(){locked=false;$(this).removeClass('heartage-zero-height')
$details.addClass('heartage-open')
$(this).css('height','auto')})
clearInterval(poller);}},100)}}}else{e.preventDefault();}});}}
this.processTemplate=function($target){var id=$target[0].id
for(var i in self.data.TextAreas){var re=new RegExp("{{"+i+"}}","g");var str=$target.html();str=str.replace(re,self.data.TextAreas[i])
var re=new RegExp("src=\"images/","g");str=str.replace(re,'src="'+self.path+'images/')
$target.html(str);}
if(self.edge){$('details>summary').replaceWith(function(){return $("<a />",{html:$(this).html()}).addClass('heartage-edge-summary');});$('details').replaceWith(function(){return $("<div />",{html:$(this).html()}).addClass('heartage-edge-details');});$target.find('a').attr('tabindex',0)}
self.loaded++
if(self.loaded>=3){self.loaded=0
self.splash=new splashObj(this);self.form=new formObj(this);self.heartage=new heartageObj(self.path+"z_lookupData.js");self.splash.setEvents();self.form.setEvents();self.results=new resultsObj(this);self.results.setEvents();self.resizeLayout(self.size*3.75,0);self.analyticsObj=new analytics(self,{'id':'NHS-oneyou-heartage','title':'Check your heart age','category':'Self assessments'},self.syn_id);self.analyticsObj.antbitsLog(true,0)}}
this.getData=function(session_log){session_log.v=0
session_log.et='Not stated'
session_log.eth=0
session_log.smk=0
session_log.age=0
session_log.bmi=0
session_log.pc=0
session_log.tn=0
session_log.ch=0
session_log.sbp=0
session_log.p=Math.min(self.page,5)
return session_log;}
this.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)?true:false;},Tablet:function(){return navigator.userAgent.match(/iPad|(?!.*mobile).*Android*/i)?true:false;},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)?true:false;},Windows:function(){return navigator.userAgent.match(/IEMobile/i)?true:false;},any:function(){return(self.isMobile.Android()||self.isMobile.iOS()||self.isMobile.Windows()||self.isMobile.Tablet());}};this.arrayUnique=function(a){return a.reduce(function(p,c){if(p.indexOf(c)<0)p.push(c);return p;},[]);};this.replaceAll=function(str,mapObj){var re=new RegExp(Object.keys(mapObj).join("|"),"gi");return str.replace(re,function(matched){return mapObj[matched.toLowerCase()];});}
this.linkOut=function(url){if(self.postmessage){self.msg_obj.action="redirect"
self.msg_obj.data={"url":url};window.parent.postMessage(JSON.stringify(self.msg_obj),'*');}else{window.open(url);}}
function getUrlVars(){var vars=[],hash;var hashes=window.location.href.slice(window.location.href.indexOf('?')+1).split('&');for(var i=0;i<hashes.length;i++)
{hash=hashes[i].split('=');vars.push(hash[0]);vars[hash[0]]=hash[1];}
return vars;}}
var resultsObj=function(parent){var self=this;var calc_delay=14
var bmi_intervention
var brackets={'cholesterol':[1,8],'bp':[90,140]};var eth_alt=[2,3,4,5,8];var ch_rs_low,ch_rs_high,bp_rs_low,bp_rs_high
var more=0;var ex=0;var text_bracket='text_over_40'
var skipped
var advice_obj=[{'title':'Smoking','result_key':'Smoking','advice_status':'[qval]','text':'','key':null,'qval':'self.form_data.smoke_str','val':'self.form_data.heartage_input.smoke_cat','info':false},{'title':'Weight','result_key':'Weight','advice_status':'Your BMI is [qval] [risk] ','risk':0,'text':'','key':null,'qval':'self.form_data.heartage_input.bmi_rounded','val':'self.form_data.heartage_input.bmi','info':false},{'title':'Your cholesterol','result_key':'Cholesterol','advice_status':'Ratio [qval] [risk] ','text':'','key':'c','qval':'self.form_data.ch_str','val':'self.form_data.heartage_input.rati','info':false},{'title':'Your blood pressure','result_key':'BloodPressure','advice_status':'[qval] [risk] ','text':'','key':'bp','qval':'self.form_data.heartage_input.sbp','val':'self.form_data.heartage_input.sbp','info':false}];var $advice=$('#heartage-results-advice');var links=[];self.interventions={};self.parent=parent;self.form_data=null;self.ha=0;self.baseline={"age":40,"b_AF":false,"b_ra":false,"b_renal":false,"b_treatedhyp":false,"b_type2":false,"bmi":22.49,"ethrisk":1,"fh_cvd":false,"rati":4.583333333333334,"sbp":130,"smoke_cat":0,"town":-0.81}
this.setEvents=function(){$('#heartage-back-btn').on('click',function(e){e.preventDefault();self.parent.nav('form')})
$('#heartage-restart-btn').on('click',function(e){e.preventDefault();self.parent.form.clear()
self.parent.nav('splash')})
$('#heartage-results-footer img').attr('src',self.parent.path+'assets/bp-im2.jpg')
self.parent.initDetails('heartage-page-results')
$('#heartage-results-footer a').click(function(e){e.preventDefault();self.logLink(e.target.href)
self.parent.linkOut(e.target.href)});}
this.generateResults=function(form_data){self.parent.page=5
self.form_data=form_data;self.user_result=self.cloneObj(self.parent.heartage.getHeartage(self.form_data.heartage_input))
if(typeof _satellite!='undefined'&&self.parent.config.adobe_analytics&&self.parent.config.adobe_state<2){self.parent.config.adobe_state=2
_satellite.track("tool_complete",{toolName:self.parent.tool_name,toolCategory:self.parent.tool_cat,toolResult:'heart age: '+self.user_result.result.heartage})}
self.parent.analyticsObj.antbitsLog(true,0)}
this.renderResults=function(rs){self.interventions={};if($.inArray(self.form_data.heartage_input.ethrisk,eth_alt)>=0){bmi_intervention=23.5;}else{bmi_intervention=25;};$('#heartage-interventions>div').html('');if(self.form_data.heartage_input.smoke_cat>1){self.createIntervention('smoke_cat','Quit smoking',1);}
if(self.form_data.heartage_input.bmi>bmi_intervention){self.createIntervention('bmi','Lose weight',bmi_intervention);}
if(self.form_data.heartage_input.rati>3.214){self.createIntervention('rati','Lower cholesterol',3.214);}
if(self.form_data.heartage_input.sbp>119){self.createIntervention('sbp','Reduce blood pressure',119);}
if(Object.keys(self.interventions).length==0){$('#heartage-interventions').hide()}else{$('#heartage-interventions').show()}
self.applyIntervention();self.renderAdvice();}
this.renderAdvice=function(){var preload_arr=[];if(self.user_result.result.age<40){text_bracket='text_under_40'
$('#heartage-results-footer>h3').html(self.parent.data.TextAreas.footer_title);$('#heartage-results-footer>p').html(self.parent.data.TextAreas.footer_under_40);}else{text_bracket='text_over_40'
$('#heartage-results-footer>h3').html(self.parent.data.TextAreas.footer_title);$('#heartage-results-footer>p').html(self.parent.data.TextAreas.footer_over_40);}
$advice.html('');for(var i in advice_obj){if(!(advice_obj[i].result_key=='Smoking'&&self.form_data.heartage_input.smoke_cat==0)){var result_obj=self.parent.data[advice_obj[i].result_key];var val=eval(advice_obj[i].val);var result_obj=self.parent.data[advice_obj[i].result_key];var tc
if(skipped.indexOf(advice_obj[i].key)>-1){val=10000;}
var result_set=null;var rso=result_obj;if(advice_obj[i].result_key=='Weight'){if($.inArray(self.form_data.heartage_input.ethrisk,eth_alt)>=0){rso=result_obj.slice(4,8);}else{rso=result_obj.slice(0,4);}}
if(advice_obj[i].result_key=='Cholesterol'){tc=self.form_data.heartage_input.tc;};for(var j in rso){result_set=rso[j];if(eval(val+' '+rso[j].bracket)){break;};};var msg=result_set[text_bracket]
if(val==10000&&advice_obj[i].result_key=='Cholesterol'){msg=result_set[text_bracket].replace('[ch_low]','<strong>'+ch_rs_low.result.heartage+'</strong>');msg=msg.replace('[ch_high]','<strong>'+ch_rs_high.result.heartage+'</strong>');}
if(val==10000&&advice_obj[i].result_key=='BloodPressure'){msg=result_set[text_bracket].replace('[bp_low]','<strong>'+bp_rs_low.result.heartage+'</strong>');msg=msg.replace('[bp_high]','<strong>'+bp_rs_high.result.heartage+'</strong>');}
if(advice_obj[i].result_key=='BloodPressure'){msg=msg.replace('[bp]',self.form_data.heartage_input.sbp);}
var output='<div class = "heartage-panel-light heartage-advice-row">';output+='<h3>'+advice_obj[i].title+'</h3>';if(skipped.indexOf(advice_obj[i].key)>-1){if(self.form_data.heartage_input.age<40){output+='<div class="heartage-advice-status-unknown">'+self.parent.data.TextAreas.not_known_under_40+'</div>';}else{output+='<div class="heartage-advice-status-unknown">'+self.parent.data.TextAreas.not_known+'</div>';}}else{var status_str=advice_obj[i].advice_status;status_str=status_str.replace('[qval]',eval(advice_obj[i].qval)).replace('[risk]',result_set.type);if(advice_obj[i].result_key=='Smoking'){status_str='You '+status_str.slice(1);}
if(advice_obj[i].result_key=='Cholesterol'){if(j!=1||tc>=5){status_str='Total: '+tc+' '+result_set.type;}}
output+='<div class="heartage-advice-status">'+status_str+'</div>';}
output+='<p>'+msg+'</p><div class = "heartage-info-panel"><h3>'+result_set.contenttitle+'</h3>';var items=result_set.resource.split(',')
for(var j in items){var rObj=self.parent.data.Resources[items[j]];output+='<div class = "heartage-info-item">';output+='<div class = "heartage-col-left"><img border = "0" aria-hidden="true" alt="'+rObj.image_alt+'" src = "'+self.parent.path+'assets/'+rObj.image+'"/></div>';output+='<div class = "heartage-col-right">'+rObj.description.replace('<a','<a href = "'+rObj.url+'" target="_blank"')+'</div></div>'}
output+='</div></div></div></div>';$advice.append(output);$('#infoDB_'+i).css('background-image','none');}}
$('#heartage-results-advice a').click(function(e){e.preventDefault();self.logLink(e.target.href)
self.parent.linkOut(e.target.href)});}
this.toggleIntervention=function(key){if(key.length>0){if(self.interventions[key].state){self.interventions[key].state=false}else{self.interventions[key].state=true}}
self.applyIntervention();self.parent.scrollEvent($('#tool_heart-age').position().top)}
this.applyIntervention=function(){var msg=''
ch_rs_low={'result':{'heartage':95}};ch_rs_high={'result':{'heartage':0}};bp_rs_low={'result':{'heartage':95}};bp_rs_high={'result':{'heartage':0}};$('#heartage-masthead>span>h2').html('Your heart age is <span role="text">about</span>');var prefix='is';var input=self.cloneObj(self.form_data.heartage_input);for(var i in self.interventions){if(self.interventions[i].state==true){input[i]=self.interventions[i].val;prefix='could be';$('#heartage-masthead>span>h2').html('Your heart age could be <span role="text">about</span>');}};var rs=self.cloneObj(self.parent.heartage.getHeartage(input));msg+=self.parent.data.Results.risk[text_bracket].replace('[10_yr_risk]',rs.result['10_yr_risk']).replace('[prefix]',prefix);skipped=''
var bracket_input=self.cloneObj(input)
if(!self.form_data.ch_skipped&&!self.form_data.bp_skipped){msg+='<p>';if(self.form_data.heartage_input.age>rs.result.heartage){msg+=self.parent.data.Results.younger[text_bracket];}else if(Math.floor(self.form_data.heartage_input.age)==rs.result.heartage){msg+=self.parent.data.Results.same[text_bracket];}else{msg+=self.parent.data.Results.older[text_bracket];};msg+='</p>';}else{if(self.form_data.ch_skipped){skipped+='c'
input.rati=brackets.cholesterol[0];ch_rs_low=self.cloneObj(self.parent.heartage.getHeartage(input));input.rati=brackets.cholesterol[1];ch_rs_high=self.cloneObj(self.parent.heartage.getHeartage(input));input.rati=self.baseline.rati;}
if(self.form_data.bp_skipped){skipped+='bp'
input.sbp=brackets.bp[0];bp_rs_low=self.cloneObj(self.parent.heartage.getHeartage(input));input.sbp=brackets.bp[1];bp_rs_high=self.cloneObj(self.parent.heartage.getHeartage(input));input.sbp=self.baseline.sbp;}}
if(skipped!=''){var str=self.parent.data.Results[skipped][text_bracket];switch(skipped){case"cbp":str=str.replace('[heart_age_low]',Math.min(bp_rs_low.result.heartage,ch_rs_low.result.heartage));str=str.replace('[heart_age_high]',Math.max(bp_rs_high.result.heartage,ch_rs_high.result.heartage));break;case"bp":str=str.replace('[heart_age_low]',bp_rs_low.result.heartage);str=str.replace('[heart_age_high]',bp_rs_high.result.heartage);break;case"c":str=str.replace('[heart_age_low]',ch_rs_low.result.heartage);str=str.replace('[heart_age_high]',ch_rs_high.result.heartage);break;}
msg+=str;}
$('#heartage-life-expectancy').html(Math.floor(rs.result.life))
$('#heartage-about-your-calculation').html(msg)
self.counter(0,rs.result.heartage,$('#heartage-number'),$('#heartage-animated-number'))}
this.createIntervention=function(key,title,val){self.interventions[key]={'val':val,'title':title,'state':false};var info=self.parent.data.TextAreas['intervention_'+key]
if(key=='bmi'){info=info.replace('[OVERWEIGHT]',bmi_intervention-0.1)}
var $node=$('<div class = "heartage-intervention"><label class="heartage-slider"><input  aria-label = "See how your heart age changes if you '+title+'" id="heartage-intervention-'+key+'" type = "checkbox"><span class="heartage-slider_toggle"></span><div><h3>'+title+'</h3><p>'+info+'</p></div></label></div>')
$('#heartage-interventions>div').append($node)
$node.find('input').on('click',function(e){var $target=$(e.target)
self.toggleIntervention($target[0].id.split('-').pop())})
function swipe(e,direction){var $target=$(e.target)
var key=$target[0].id.split('-').pop()
if(key.length>0){if(direction=='left'&&self.interventions[key].state){self.toggleIntervention(key)}
if(direction=='right'&&!self.interventions[key].state){self.toggleIntervention(key)}}}
if(self.parent.isMobile.any()){var slider=new Hammer(document.getElementById('heartage-intervention-'+key));slider.on('swipeleft',function(e){swipe(e,'left')});slider.on('swiperight',function(e){swipe(e,'right')});}}
this.preload=function(form_data){self.generateResults(form_data);self.parent.scrollEvent($('#tool_heart-age').position().top)
var $preloader=$('<div id="heartage-preloader"><div></div><h2>Generating results</h2></div>')
self.parent.$target.append($preloader)
$preloader.fadeOut(0).fadeIn(self.parent.speed).delay(self.parent.speed*calc_delay).fadeOut(self.parent.speed);setTimeout(function(){self.renderResults();self.parent.nav('results')},self.parent.speed*calc_delay)}
this.cloneObj=function(obj){return jQuery.parseJSON(JSON.stringify(obj));}
this.counter=function(start,num,$target,$animated_target){$target.html(num);$animated_target.html(num);self.counter_delay=self.parent.speed*5.5;var inc=20;var count=start;var t=0;function stepNext(){setTimeout(function(){if(count<=num){$animated_target.html(count);count++;if(count>num-15){inc*=1.08;}
stepNext();}},inc);}
stepNext();}
this.logLink=function(t){var mapObj={'https://':'','http://':'','www.':'','nhs.uk':''};links.push(self.parent.replaceAll(t,mapObj));links=self.parent.arrayUnique(links);ex=1;more=1}
this.getData=function(obj){if(typeof self.user_result!='undefined'){obj.bmi=self.user_result.user_data.bmi.toFixed(1);obj.age=self.user_result.user_data.age;obj.gen=self.user_result.user_data.gender;obj.af=self.user_result.user_data.b_AF?1:0;obj.art=self.user_result.user_data.b_ra?1:0;obj.kid=self.user_result.user_data.b_renal?1:0;obj.btp=self.user_result.user_data.b_treatedhyp?1:0;obj.dia=self.user_result.user_data.b_type2?1:0;obj.lf=self.user_result.result.life.toFixed(1)
obj.h=self.user_result.result.heartage
obj.links=links.join('|');obj.more=more;obj.ex=ex;}
return obj;}}
var splashObj=function(parent){var self=this;self.parent=parent;this.setEvents=function(){self.parent.initDetails('heartage-page-splash');$('#heartage-start-btn').on('click',function(e){e.preventDefault();self.parent.nav('form')
self.parent.page+=1
if(typeof _satellite!='undefined'&&self.parent.config.adobe_analytics&&self.parent.config.adobe_state<1){self.parent.config.adobe_state=1
_satellite.track("tool_start",{toolName:self.parent.config.tool_name,toolCategory:self.parent.config.tool_cat})}
self.parent.analyticsObj.antbitsLog(true,0);})}}